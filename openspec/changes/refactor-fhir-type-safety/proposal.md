# Refactor FHIR Type Safety

## Why

The current FHIR implementation uses `any` types in **620+ locations** across R5 resources, which causes:

1. **Loss of type safety** - Requires manual type assertions and marshaling/unmarshaling at every use site
2. **Poor developer experience** - Users must write boilerplate code like:
   ```go
   resourceBytes, _ := json.Marshal(*entry.Resource)
   var serviceRequest ServiceRequest
   json.Unmarshal(resourceBytes, &serviceRequest)
   ```
3. **Inconsistent patterns** - R5 uses `*any` while base implementation correctly uses `json.RawMessage`
4. **Runtime errors** - Type mismatches only discovered at runtime instead of compile time
5. **Violates FHIR spec** - Choice types should use expanded field names (e.g., `deceasedBoolean`, not `deceased`)

Real-world FHIR JSON uses expanded field names (proven in `testdata/fhir/r4/examples/patient-example.json:70`),
but our R5 implementation doesn't match this pattern.

The base implementation (`fhir/bundle.go`) and R4 resources already demonstrate the correct patterns using
`json.RawMessage` and expanded choice fields - these patterns just need to be applied consistently across R5.

## What Changes

This proposal eliminates all `any` types and replaces them with type-safe alternatives:

### 1. **Contained Resources** (150+ occurrences)
```go
// BEFORE
type DomainResource struct {
    Contained []interface{} `json:"contained,omitempty"`
}

// AFTER
type DomainResource struct {
    Contained []json.RawMessage `json:"contained,omitempty"`
}

// With helper methods
func (r *DomainResource) UnmarshalContainedResource(idx int) (any, error)
func (r *DomainResource) AddContainedResource(resource interface{}) error
```

### 2. **Bundle Entry Resources** (3 occurrences)
```go
// BEFORE (R5)
type BundleEntry struct {
    Resource *any `json:"resource,omitempty"`
}

// AFTER (match base implementation)
type BundleEntry struct {
    Resource json.RawMessage `json:"resource,omitempty"`
}

// With helper method (requested by users)
func (e *BundleEntry) UnmarshalResource(v interface{}) error
```

### 3. **FHIR Choice Types** (300+ occurrences)
```go
// BEFORE
type Patient struct {
    Deceased *any `json:"deceased,omitempty"`
}

// AFTER (expanded fields)
type Patient struct {
    // Choice type: deceased[x]
    DeceasedBoolean  *bool                `json:"deceasedBoolean,omitempty" fhir:"choice=deceased"`
    DeceasedDateTime *primitives.DateTime `json:"deceasedDateTime,omitempty" fhir:"choice=deceased"`
}
```

### 4. **Polymorphic Value Types** (50 occurrences)
```go
// BEFORE
type UsageContext struct {
    Value any `json:"value"`
}

// AFTER (tagged union with custom marshaling)
type UsageContextValue struct {
    CodeableConcept *CodeableConcept `json:"valueCodeableConcept,omitempty"`
    Quantity        *Quantity        `json:"valueQuantity,omitempty"`
    Range           *Range           `json:"valueRange,omitempty"`
    Reference       *Reference       `json:"valueReference,omitempty"`
}
```

### 5. **Code Generator Updates**

The generator already implements choice type expansion (`typemapper.go:129-161`, `builder.go:211-244`), but needs
enhancements:

1. **Fix polymorphic Resource fields** (`typemapper.go:44`):
   - Change `"Resource": "any"` to use `json.RawMessage`
   - Update generator to emit `json.RawMessage` for Bundle.entry.resource and contained resources

2. **Fix non-choice polymorphic fallback** (`typemapper.go:122`):
   - Currently falls back to `any` for multiple types that aren't choice types
   - Investigate and handle these edge cases properly

3. **Add R5 support to generation script** (`scripts/generate.sh`):
   - Currently only generates R4 resources
   - Add R5 schema download and generation capability

4. **Add generated code comments** (`codegen/generator.go`):
   - Add header comment: "Code generated by fhirgen. DO NOT EDIT."
   - Include generation timestamp and FHIR version
   - Add reference to source StructureDefinition URL

5. **Download and track R5 schemas** (`fhir_schemas/`):
   - Download R5 profiles-resources.json and profiles-types.json
   - Track schemas in version control for reproducible generation
   - Document schema version and download source

### 6. **Regenerate All R5 Resources**

After generator improvements, regenerate all 202 R5 resource files:

```bash
# Download R5 schemas (first time)
./fhir/scripts/download_r5_schemas.sh

# Generate R5 resources
./fhir/scripts/gen/bin/fhirgen -version r5 \
  -input fhir_schemas/r5/profiles-resources.json \
  -output fhir/r5/resources \
  -verbose

# Generate R5 complex types
./fhir/scripts/gen/bin/fhirgen -version r5 \
  -input fhir_schemas/r5/profiles-types.json \
  -output fhir/r5/types \
  -verbose
```

## Impact

### Affected Specs
- **ADDED**: `fhir-type-system` - type-safe patterns for FHIR polymorphic types

### Affected Code

**Generator Scripts** (located at `/Users/Andru.Che@annalise.ai/dicom/go-radx/fhir/scripts/gen/`):
- `parser/typemapper.go:44` - Change `"Resource": "any"` → `"Resource": "json.RawMessage"`
- `parser/typemapper.go:122` - Fix fallback for non-choice polymorphic types
- `codegen/generator.go:250-272` - Add generated code header comments with metadata
- `codegen/builder.go` - Already implements choice expansion, no changes needed
- `main.go` - Already supports R5, no changes needed

**Generation Scripts**:
- `scripts/generate.sh` - Update to support R5 or create `scripts/generate_r5.sh`
- `scripts/download_r5_schemas.sh` - **NEW** - Script to download R5 schemas

**Base Types** (manual changes):
- `fhir/resource.go:42` - Change `Contained []interface{}` → `Contained []json.RawMessage`
- `fhir/resource.go` - Add `UnmarshalContainedResource(idx int)` helper method
- `fhir/resource.go` - Add `AddContainedResource(resource interface{})` helper method

**Generated Code** (regenerated via generator):
- `fhir/r5/resources/*.go` - All 202 resources regenerated with choice expansion
- `fhir/r5/types/*.go` - All complex types regenerated

**Validation**:
- `fhir/validation/validator.go` - Add validation for expanded choice types

**Testing**:
- `fhir/scripts/gen/codegen/generator_test.go` - Add tests for generated code format
- `fhir/scripts/gen/parser/typemapper_test.go` - Add tests for json.RawMessage mapping
- `fhir/r5/resources/bundle_test.go` - Add tests for UnmarshalResource helper
- `fhir/resource_test.go` - Add tests for contained resource helpers

### New Features
- `BundleEntry.UnmarshalResource(v interface{}) error` - User-requested helper method
- `DomainResource.UnmarshalContainedResource(idx int) (any, error)` - Helper for contained resources
- Choice type validation - Ensures only one field per choice group is set

### Breaking Changes
**BREAKING**: This introduces breaking changes to all R5 resource types:

1. **Choice field API changes**:
   ```go
   // Old
   patient.Deceased = &someValue

   // New
   patient.DeceasedBoolean = &boolValue
   // OR
   patient.DeceasedDateTime = &dateTimeValue
   ```

2. **Bundle/Contained resource access**:
   ```go
   // Old
   resource := entry.Resource.(*Patient) // Direct type assertion

   // New
   var patient Patient
   err := entry.UnmarshalResource(&patient) // Explicit unmarshal
   ```

3. **Type detection**:
   ```go
   // Old - runtime type switches on any
   switch v := value.(type) {
   case bool: ...
   case time.Time: ...
   }

   // New - compile-time field access
   if patient.DeceasedBoolean != nil {
       // Handle boolean
   } else if patient.DeceasedDateTime != nil {
       // Handle datetime
   }
   ```

### Migration Path
1. **Breaking release**: Direct breaking change, no v1/v2 simultaneous support
2. **Migration guide**: Provide comprehensive examples for common patterns
3. **Single version**: Only maintain the new type-safe version going forward
4. **Clear release notes**: Document all breaking changes with migration examples

### Benefits
- ✅ **Type safety** - Compile-time type checking instead of runtime assertions
- ✅ **Better IDE support** - Autocomplete and type hints for choice fields
- ✅ **Matches FHIR spec** - Uses correct JSON field names as per spec
- ✅ **Performance** - Lazy deserialization with json.RawMessage
- ✅ **Consistency** - R5 matches base implementation patterns
- ✅ **Better errors** - Type mismatches caught at compile time

### Risk Mitigation
1. **Comprehensive testing** - Test against real-world FHIR examples in testdata/
2. **Roundtrip validation** - Ensure JSON → struct → JSON produces identical output
3. **Backward compatibility tests** - Ensure existing v1 JSON can be parsed by v2
4. **Performance benchmarks** - Verify no regression in marshal/unmarshal performance