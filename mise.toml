# Mise configuration for go-radx
# See: https://mise.jdx.dev

# ============================================================================
# Tools
# ============================================================================
[tools]
go = "1.25.4"
python = "3.14"  # For MkDocs and documentation tools
uv = "latest"    # Fast Python package manager

# ============================================================================
# Environment Variables
# ============================================================================
[env]
CGO_ENABLED = "1"
GOFLAGS = "-buildvcs=false"

# ============================================================================
# Tasks
# ============================================================================

# ----------------------------------------------------------------------------
# Code Quality Tasks
# ----------------------------------------------------------------------------

[tasks.fmt]
description = "Format Go code with gofmt"
run = """
echo "Running gofmt..."
gofmt -w -s .
echo "âœ“ Code formatted"
"""

[tasks."fmt:check"]
description = "Check if code is formatted"
run = """
echo "Checking code formatting..."
if [ -n "$(gofmt -l .)" ]; then
    echo "Code is not formatted. Run 'mise fmt'"
    exit 1
fi
echo "âœ“ Code formatting check passed"
"""

[tasks.lint]
description = "Run golangci-lint"
run = """
echo "Running golangci-lint..."
if ! command -v golangci-lint >/dev/null 2>&1; then
    echo "golangci-lint not installed. Run: mise tools:lint"
    exit 1
fi
golangci-lint run ./...
echo "âœ“ Linting passed"
"""

# ----------------------------------------------------------------------------
# Testing Tasks
# ----------------------------------------------------------------------------

[tasks.test]
description = "Run all tests"
run = """
echo "Running tests..."
go test -v -timeout 10m ./...
echo "âœ“ Tests passed"
"""

[tasks."test:short"]
description = "Run short tests only"
run = """
echo "Running short tests..."
go test -v -short -timeout 10m ./...
echo "âœ“ Short tests passed"
"""

[tasks."test:coverage"]
description = "Run tests with coverage"
run = """
echo "Running tests with coverage..."
go test -v -timeout 10m -coverprofile=coverage.out -covermode=atomic ./...
echo "âœ“ Tests passed with coverage"
"""

[tasks."coverage:html"]
description = "Generate HTML coverage report"
depends = ["test:coverage"]
run = """
echo "Generating HTML coverage report..."
go tool cover -html=coverage.out -o coverage.html
echo "âœ“ Coverage report generated: coverage.html"
"""

[tasks."coverage:report"]
description = "Display coverage report in terminal"
depends = ["test:coverage"]
run = """
echo "Coverage report:"
go tool cover -func=coverage.out
"""

# ----------------------------------------------------------------------------
# Module Management Tasks
# ----------------------------------------------------------------------------

[tasks.tidy]
description = "Tidy Go modules"
run = """
echo "Tidying Go modules..."
go mod tidy
echo "âœ“ Go modules tidied"
"""

[tasks.verify]
description = "Verify Go modules"
run = """
echo "Verifying Go modules..."
go mod verify
echo "âœ“ Go modules verified"
"""

[tasks.download]
description = "Download Go module dependencies"
run = """
echo "Downloading dependencies..."
go mod download
echo "âœ“ Dependencies downloaded"
"""

# ----------------------------------------------------------------------------
# CGo Dependency Tasks
# ----------------------------------------------------------------------------

[tasks."deps:check"]
description = "Check CGo dependencies (C compiler, libraries)"
run = """
echo "Checking CGo dependencies..."

# Check CGO_ENABLED
if [ "$(go env CGO_ENABLED)" != "1" ]; then
    echo "âœ— CGO_ENABLED is not set to 1"
    echo "  Run: export CGO_ENABLED=1"
    exit 1
fi
echo "âœ“ CGO_ENABLED=1"

# Check C compiler
HAS_GCC=0
HAS_CLANG=0
if command -v gcc >/dev/null 2>&1; then
    HAS_GCC=1
fi
if command -v clang >/dev/null 2>&1; then
    HAS_CLANG=1
fi

if [ "$HAS_GCC" = "0" ] && [ "$HAS_CLANG" = "0" ]; then
    echo "âœ— No C compiler found (gcc or clang required)"
    echo "  macOS: xcode-select --install"
    echo "  Linux: apt-get install build-essential (or equivalent)"
    exit 1
fi

if [ "$HAS_GCC" = "1" ]; then
    echo "âœ“ C compiler available: gcc"
elif [ "$HAS_CLANG" = "1" ]; then
    echo "âœ“ C compiler available: clang"
fi

# Check pkg-config
if ! command -v pkg-config >/dev/null 2>&1; then
    echo "âœ— pkg-config not found"
    echo "  macOS: brew install pkg-config"
    echo "  Linux: apt-get install pkg-config"
    exit 1
fi
echo "âœ“ pkg-config available"

# Check libjpeg (accept either libjpeg or libturbojpeg)
if pkg-config --exists libjpeg 2>/dev/null; then
    echo "âœ“ libjpeg-turbo installed (version: $(pkg-config --modversion libjpeg))"
elif pkg-config --exists libturbojpeg 2>/dev/null; then
    echo "âœ“ libjpeg-turbo installed (version: $(pkg-config --modversion libturbojpeg))"
else
    echo "âœ— libjpeg-turbo not found"
    echo "  macOS: brew install jpeg-turbo"
    echo "  Ubuntu/Debian: apt-get install libturbojpeg0-dev"
    echo "  Fedora/RHEL: yum install turbojpeg-devel"
    exit 1
fi

# Check OpenJPEG
if ! pkg-config --exists libopenjp2 2>/dev/null; then
    echo "âœ— OpenJPEG not found"
    echo "  macOS: brew install openjpeg"
    echo "  Ubuntu/Debian: apt-get install libopenjp2-7-dev"
    echo "  Fedora/RHEL: yum install openjpeg2-devel"
    exit 1
fi
echo "âœ“ OpenJPEG installed (version: $(pkg-config --modversion libopenjp2))"
echo "âœ“ All CGo dependencies satisfied"
"""

[tasks."deps:install"]
description = "Install CGo dependencies (macOS/Linux only)"
run = """
echo "Installing CGo dependencies..."

UNAME_S=$(uname -s)

if [ "$UNAME_S" = "Darwin" ]; then
    # macOS with Homebrew
    if command -v brew >/dev/null 2>&1; then
        echo "Installing via Homebrew..."
        brew install jpeg-turbo openjpeg pkg-config
    else
        echo "âœ— Homebrew not found. Install from https://brew.sh"
        exit 1
    fi
elif [ "$UNAME_S" = "Linux" ]; then
    # Linux - try apt, then yum/dnf
    if command -v apt-get >/dev/null 2>&1; then
        echo "Installing via apt-get..."
        sudo apt-get update
        sudo apt-get install -y libjpeg-turbo8-dev libturbojpeg0-dev libopenjp2-7-dev build-essential pkg-config
    elif command -v dnf >/dev/null 2>&1; then
        echo "Installing via dnf..."
        sudo dnf groupinstall -y "Development Tools"
        sudo dnf install -y turbojpeg-devel openjpeg2-devel pkg-config
    elif command -v yum >/dev/null 2>&1; then
        echo "Installing via yum..."
        sudo yum groupinstall -y "Development Tools"
        sudo yum install -y turbojpeg-devel openjpeg2-devel pkgconfig
    else
        echo "âœ— Unsupported package manager. Please install manually:"
        echo "  - libjpeg-turbo"
        echo "  - OpenJPEG 2.5+"
        exit 1
    fi
else
    echo "âœ— Unsupported platform: $UNAME_S"
    echo "  Only macOS and Linux are supported"
    exit 1
fi

echo "âœ“ CGo dependencies installed"
echo "Run 'mise deps:check' to verify installation"
"""

# ----------------------------------------------------------------------------
# Build Tasks
# ----------------------------------------------------------------------------

[tasks.build]
description = "Build the project with CGo enabled"
run = """
echo "Building with CGo..."
CGO_ENABLED=1 go build -v ./...
echo "âœ“ Build complete"
"""

[tasks."build:cli"]
description = "Build the dicomutil CLI tool"
run = """
echo "Building dicomutil CLI..."
mkdir -p ./bin
CGO_ENABLED=1 go build -v -o ./bin/go-dicom ./cmd/dicomutil
echo "âœ“ CLI built: ./bin/go-dicom"
"""

# ----------------------------------------------------------------------------
# Radx CLI Tasks
# ----------------------------------------------------------------------------

[tasks."radx:build"]
description = "Build the radx DICOM CLI tool"
run = """
echo "Building radx CLI..."
mkdir -p ./bin
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "develop")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS="-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.Date=${BUILD_DATE}"
cd cmd/radx && CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -v -o ../../bin/radx .
echo "âœ“ radx CLI built: ./bin/radx"
echo "  Version: ${VERSION}"
echo "  Commit: ${COMMIT}"
echo "  Build Date: ${BUILD_DATE}"
"""

[tasks."radx:install"]
description = "Install radx CLI to GOPATH/bin"
run = """
echo "Installing radx CLI..."
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "develop")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS="-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.Date=${BUILD_DATE}"
cd cmd/radx && CGO_ENABLED=0 go install -ldflags="${LDFLAGS}" -v .
echo "âœ“ radx installed to $(go env GOPATH)/bin/radx"
"""

[tasks."radx:test"]
description = "Run tests for radx CLI"
run = """
echo "Running radx CLI tests..."
go test -v -timeout 5m ./cmd/radx/...
echo "âœ“ radx CLI tests passed"
"""

[tasks."radx:clean"]
description = "Clean radx CLI build artifacts"
run = """
echo "Cleaning radx CLI artifacts..."
rm -f ./bin/radx
rm -f ./bin/radx-*
echo "âœ“ radx CLI cleaned"
"""

[tasks."radx:compile"]
description = "Build radx CLI for multiple platforms (darwin-arm64, darwin-amd64, linux-amd64, linux-arm64)"
run = """
echo "Building radx CLI for multiple platforms..."
mkdir -p ./bin

VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "develop")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS="-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.Date=${BUILD_DATE}"

echo "Build info:"
echo "  Version: ${VERSION}"
echo "  Commit: ${COMMIT}"
echo "  Build Date: ${BUILD_DATE}"
echo ""

# Darwin ARM64 (Apple Silicon)
echo "Building darwin-arm64..."
cd cmd/radx && GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -v -o ../../bin/radx-darwin-arm64 .
cd ../..
echo "âœ“ darwin-arm64 built: ./bin/radx-darwin-arm64"

# Darwin AMD64 (Intel Mac)
echo "Building darwin-amd64..."
cd cmd/radx && GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -v -o ../../bin/radx-darwin-amd64 .
cd ../..
echo "âœ“ darwin-amd64 built: ./bin/radx-darwin-amd64"

# Linux AMD64
echo "Building linux-amd64..."
cd cmd/radx && GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -v -o ../../bin/radx-linux-amd64 .
cd ../..
echo "âœ“ linux-amd64 built: ./bin/radx-linux-amd64"

# Linux ARM64
echo "Building linux-arm64..."
cd cmd/radx && GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -v -o ../../bin/radx-linux-arm64 .
cd ../..
echo "âœ“ linux-arm64 built: ./bin/radx-linux-arm64"

echo ""
echo "âœ“ All platforms built successfully:"
ls -lh ./bin/radx-*
"""

# ----------------------------------------------------------------------------
# SBOM Tasks
# ----------------------------------------------------------------------------

[tasks.sbom]
description = "Generate CycloneDX SBOM (packages only)"
run = """
echo "Generating CycloneDX v1.6 SBOM..."
mkdir -p ./sbom
if ! command -v trivy >/dev/null 2>&1; then
    echo "Trivy not installed. Run 'mise tools:sbom'"
    exit 1
fi
trivy fs --format cyclonedx --output ./sbom/go-dicom.sbom.json .
echo "âœ“ SBOM generated: ./sbom/go-dicom.sbom.json"
"""

[tasks."sbom:vuln"]
description = "Generate CycloneDX SBOM with vulnerabilities"
run = """
echo "Generating CycloneDX v1.6 SBOM with vulnerabilities..."
mkdir -p ./sbom
if ! command -v trivy >/dev/null 2>&1; then
    echo "Trivy not installed. Run 'mise tools:sbom'"
    exit 1
fi
trivy fs --format cyclonedx --scanners vuln --output ./sbom/go-dicom.sbom-with-vulns.json .
echo "âœ“ SBOM with vulnerabilities generated: ./sbom/go-dicom.sbom-with-vulns.json"
"""

[tasks."sbom:full"]
description = "Generate CycloneDX SBOM with vulnerabilities and licenses"
run = """
echo "Generating comprehensive CycloneDX v1.6 SBOM..."
mkdir -p ./sbom
if ! command -v trivy >/dev/null 2>&1; then
    echo "Trivy not installed. Run 'mise tools:sbom'"
    exit 1
fi
trivy fs --format cyclonedx --scanners vuln,license --list-all-pkgs --output ./sbom/go-dicom.sbom-full.json .
echo "âœ“ Comprehensive SBOM generated: ./sbom/go-dicom.sbom-full.json"
echo "  Includes: packages, vulnerabilities, and licenses"
"""

[tasks."sbom:validate"]
description = "Validate generated SBOM files"
run = """
echo "Validating SBOM files..."
if [ -f ./sbom/go-dicom.sbom.json ]; then
    echo "Checking ./sbom/go-dicom.sbom.json..."
    trivy sbom ./sbom/go-dicom.sbom.json --quiet && echo "âœ“ ./sbom/go-dicom.sbom.json is valid"
fi
if [ -f ./sbom/go-dicom.sbom-with-vulns.json ]; then
    echo "Checking ./sbom/go-dicom.sbom-with-vulns.json..."
    trivy sbom ./sbom/go-dicom.sbom-with-vulns.json --quiet && echo "âœ“ ./sbom/go-dicom.sbom-with-vulns.json is valid"
fi
if [ -f ./sbom/go-dicom.sbom-full.json ]; then
    echo "Checking ./sbom/go-dicom.sbom-full.json..."
    trivy sbom ./sbom/go-dicom.sbom-full.json --quiet && echo "âœ“ ./sbom/go-dicom.sbom-full.json is valid"
fi
echo "âœ“ SBOM validation complete"
"""

[tasks."sbom:scan"]
description = "Scan the generated SBOM for vulnerabilities"
depends = ["sbom:full"]
run = """
echo "Scanning SBOM for vulnerabilities..."
trivy sbom --scanners vuln ./sbom/go-dicom.sbom-full.json
echo "âœ“ SBOM vulnerability scan complete"
"""

# ----------------------------------------------------------------------------
# GoReleaser Tasks
# ----------------------------------------------------------------------------

[tasks."release:install"]
description = "Install GoReleaser"
run = """
echo "Installing GoReleaser..."
if command -v brew >/dev/null 2>&1; then
    echo "Installing via Homebrew..."
    brew install goreleaser
else
    echo "Installing via install script..."
    curl -sL https://git.io/goreleaser | bash -s -- -b $(go env GOPATH)/bin
fi
echo "âœ“ GoReleaser installed"
goreleaser --version
"""

[tasks."release:check"]
description = "Validate GoReleaser configuration"
run = """
echo "Checking GoReleaser configuration..."
if ! command -v goreleaser >/dev/null 2>&1; then
    echo "GoReleaser not installed. Run 'mise release:install'"
    exit 1
fi
goreleaser check
echo "âœ“ GoReleaser configuration is valid"
"""

[tasks."release:snapshot"]
description = "Build snapshot release (for testing, no Git tag required)"
depends = ["release:check", "deps:check"]
run = """
echo "Building snapshot release with GoReleaser..."
echo "This will create a local build without publishing..."
rm -rf dist/
goreleaser release --snapshot --clean
echo "âœ“ Snapshot release built in ./dist/"
echo ""
echo "Built artifacts:"
ls -lh dist/*.tar.gz 2>/dev/null || echo "No archives found"
ls -lh dist/*.zip 2>/dev/null || echo "No zip files found"
echo ""
echo "Checksums:"
cat dist/*_checksums.txt 2>/dev/null || echo "No checksums file found"
"""

[tasks."release:build"]
description = "Build binaries only (no archives, no publish)"
depends = ["release:check", "deps:check"]
run = """
echo "Building binaries with GoReleaser..."
rm -rf dist/
goreleaser build --clean
echo "âœ“ Binaries built in ./dist/"
echo ""
echo "Built binaries:"
find dist -type f -name "radx*" -perm +111 | while read -r binary; do
    echo "  $(basename "$binary"): $(file -b "$binary" | cut -d, -f1)"
done
"""

[tasks."release:dry-run"]
description = "Perform a dry run of the release process (requires clean Git state)"
depends = ["release:check", "deps:check", "test", "lint"]
run = """
echo "Running GoReleaser in dry-run mode..."
echo "Note: This requires a clean Git working directory and a tag"
echo ""

# Check for clean git state
if [ -n "$(git status --porcelain)" ]; then
    echo "âœ— Git working directory is not clean"
    echo "  Please commit or stash your changes first"
    exit 1
fi

# Check for tag
if ! git describe --exact-match --tags HEAD 2>/dev/null; then
    echo "âš ï¸  No tag found at current commit"
    echo "  For a real release, you would need to create a tag:"
    echo "    git tag -a v0.0.1 -m 'Release v0.0.1'"
    echo ""
    echo "  Running snapshot instead..."
    goreleaser release --snapshot --clean --skip=publish
else
    TAG=$(git describe --exact-match --tags HEAD)
    echo "Found tag: $TAG"
    goreleaser release --clean --skip=publish
fi

echo "âœ“ Dry run complete"
echo ""
echo "Review the output in ./dist/ before running the actual release"
"""

[tasks."release:publish"]
description = "Create and publish a release to GitHub (requires Git tag)"
depends = ["release:check", "deps:check", "test", "lint"]
run = """
echo "Creating GitHub release with GoReleaser..."
echo ""

# Check for clean git state
if [ -n "$(git status --porcelain)" ]; then
    echo "âœ— Git working directory is not clean"
    echo "  Please commit or stash your changes first"
    exit 1
fi

# Check for tag
if ! git describe --exact-match --tags HEAD 2>/dev/null; then
    echo "âœ— No tag found at current commit"
    echo ""
    echo "To create a release:"
    echo "  1. Create a tag: git tag -a v0.0.1 -m 'Release v0.0.1'"
    echo "  2. Push the tag: git push origin v0.0.1"
    echo "  3. Run this command again"
    exit 1
fi

TAG=$(git describe --exact-match --tags HEAD)
echo "ðŸš€ Releasing version: $TAG"
echo ""

# Check for GITHUB_TOKEN
if [ -z "$GITHUB_TOKEN" ]; then
    echo "âœ— GITHUB_TOKEN environment variable not set"
    echo "  Set it with: export GITHUB_TOKEN=your_token"
    echo "  Or create one at: https://github.com/settings/tokens"
    exit 1
fi

echo "This will create a GitHub release for tag: $TAG"
echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
sleep 5

goreleaser release --clean
echo "âœ“ Release $TAG published to GitHub"
echo "  View at: https://github.com/codeninja55/go-radx/releases/tag/$TAG"
"""

[tasks."release:clean"]
description = "Clean GoReleaser build artifacts"
run = """
echo "Cleaning GoReleaser artifacts..."
rm -rf dist/
echo "âœ“ GoReleaser artifacts cleaned"
"""

[tasks."release:info"]
description = "Show information about the current release state"
run = """
echo "Release Information:"
echo "===================="
echo ""

# Current version from git
if git describe --exact-match --tags HEAD 2>/dev/null; then
    echo "Current tag: $(git describe --exact-match --tags HEAD)"
else
    echo "Current version: $(git describe --tags --always --dirty 2>/dev/null || echo 'no version')"
    echo "No tag at current commit"
fi

echo "Latest tag: $(git describe --tags --abbrev=0 2>/dev/null || echo 'no tags')"
echo ""

# Git status
if [ -n "$(git status --porcelain)" ]; then
    echo "âš ï¸  Git working directory has uncommitted changes"
else
    echo "âœ“ Git working directory is clean"
fi

# GoReleaser status
if command -v goreleaser >/dev/null 2>&1; then
    echo "âœ“ GoReleaser installed: $(goreleaser --version | head -1)"
else
    echo "âœ— GoReleaser not installed"
fi

# Check for GitHub token
if [ -n "$GITHUB_TOKEN" ]; then
    echo "âœ“ GITHUB_TOKEN is set"
else
    echo "âœ— GITHUB_TOKEN not set (required for publishing)"
fi

echo ""
echo "Recent tags:"
git tag -l --sort=-version:refname | head -5 | sed 's/^/  - /'
"""

# ----------------------------------------------------------------------------
# Documentation Tasks
# ----------------------------------------------------------------------------

[tasks."docs:install"]
description = "Install MkDocs and dependencies"
run = """
echo "Installing MkDocs and dependencies with uv..."
# Create virtual environment if it doesn't exist
if [ ! -d ".venv" ]; then
    echo "Creating Python virtual environment..."
    uv venv
fi
uv pip install -r docs/requirements.txt
echo "âœ“ MkDocs dependencies installed"
"""

[tasks."docs:serve"]
description = "Serve documentation locally"
depends = ["docs:install"]
run = "uv run mkdocs serve"

[tasks."docs:build"]
description = "Build documentation site"
depends = ["docs:install"]
run = """
echo "Building documentation..."
uv run mkdocs build
echo "âœ“ Documentation built to ./site/"
"""

[tasks."docs:deploy"]
description = "Deploy documentation to GitHub Pages"
depends = ["docs:install"]
run = """
echo "Deploying documentation to GitHub Pages..."
uv run mkdocs gh-deploy --force
echo "âœ“ Documentation deployed"
"""

[tasks."docs:clean"]
description = "Clean documentation build artifacts"
run = """
echo "Cleaning documentation artifacts..."
rm -rf site/
echo "âœ“ Documentation cleaned"
"""

# ----------------------------------------------------------------------------
# FHIR Code Generation Tasks
# ----------------------------------------------------------------------------

[tasks."gen:build"]
description = "Build the FHIR code generator (fhirgen)"
run = """
echo "Building fhirgen code generator..."
cd fhir/scripts/gen
go build -v -o bin/fhirgen .
echo "âœ“ fhirgen built: fhir/scripts/gen/bin/fhirgen"
"""

[tasks."schema:download"]
description = "Download FHIR R5 schemas from HL7 official site"
run = """
echo "Downloading FHIR R5 schemas..."
./fhir/scripts/download_r5_schemas.sh
echo "âœ“ R5 schemas downloaded to fhir_schemas/r5/"
"""

[tasks."gen:r5-resources"]
description = "Generate R5 resource structs (Patient, Observation, etc.)"
depends = ["gen:build"]
run = """
echo "Generating R5 resources..."
./fhir/scripts/gen/bin/fhirgen \\
  -version r5 \\
  -input fhir_schemas/r5/profiles-resources.json \\
  -output fhir/r5/resources \\
  -verbose
echo "âœ“ R5 resources generated in fhir/r5/resources/"
"""

[tasks."gen:r5-types"]
description = "Generate R5 complex type structs (CodeableConcept, etc.)"
depends = ["gen:build"]
run = """
echo "Generating R5 complex types..."
./fhir/scripts/gen/bin/fhirgen \\
  -version r5 \\
  -input fhir_schemas/r5/profiles-types.json \\
  -output fhir/r5/types \\
  -verbose
echo "âœ“ R5 complex types generated in fhir/r5/types/"
"""

[tasks."gen:r5-all"]
description = "Generate all R5 code (resources + types)"
depends = ["gen:r5-resources", "gen:r5-types"]
run = """
echo "âœ“ All R5 code generated successfully"
echo "  Resources: fhir/r5/resources/"
echo "  Types: fhir/r5/types/"
"""

[tasks."gen:clean"]
description = "Remove all generated code"
run = """
echo "Cleaning generated code..."
rm -rf fhir/r5/resources/*.go
rm -rf fhir/r5/types/*.go
echo "âœ“ Generated code cleaned"
"""

[tasks."gen:verify"]
description = "Verify generated code compiles and passes tests"
depends = ["gen:r5-all"]
run = """
echo "Verifying generated code..."
echo "Building..."
go build ./fhir/r5/resources
go build ./fhir/r5/types
echo "Running tests..."
go test ./fhir/r5/resources
go test ./fhir/validation
echo "âœ“ Generated code verified"
"""

# ----------------------------------------------------------------------------
# Tool Installation Tasks
# ----------------------------------------------------------------------------

[tasks."tools:lint"]
description = "Install linting tools (golangci-lint v2)"
run = """
echo "Installing golangci-lint v2..."
go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
echo "âœ“ golangci-lint installed at $(go env GOPATH)/bin/golangci-lint"
golangci-lint version
"""

[tasks."tools:sbom"]
description = "Install SBOM tools (Trivy)"
run = """
echo "Installing Trivy..."
if command -v brew >/dev/null 2>&1; then
    brew install trivy
else
    echo "Installing Trivy via install script..."
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b $(go env GOPATH)/bin
fi
echo "âœ“ Trivy installed"
trivy version
"""

[tasks."tools:install"]
description = "Install all development tools"
depends = ["tools:lint", "tools:sbom", "release:install"]

# ----------------------------------------------------------------------------
# Clean Tasks
# ----------------------------------------------------------------------------

[tasks.clean]
description = "Remove build artifacts, coverage files, and SBOMs"
run = """
echo "Cleaning..."
go clean
rm -f coverage.out coverage.html
rm -rf ./bin
rm -rf ./sbom
rm -rf ./dist
echo "âœ“ Cleaned"
"""

# ----------------------------------------------------------------------------
# Composite Tasks
# ----------------------------------------------------------------------------

[tasks.check]
description = "Run all checks (format, lint, CGo deps, test)"
depends = ["fmt:check", "lint", "deps:check", "test"]
run = """
echo "âœ“ All checks passed"
"""

[tasks.all]
description = "Clean, tidy, format, lint, and test"
run = """
mise clean
mise tidy
mise fmt
mise lint
mise test
echo "âœ“ All tasks completed"
"""

[tasks.setup]
description = "Setup complete development environment"
depends = ["deps:check", "tools:install", "docs:install", "download"]
run = """
echo "âœ“ Development environment setup complete"
"""

[tasks.ci]
description = "Run CI checks locally"
depends = ["fmt:check", "lint", "test"]
run = """
echo "âœ“ CI checks passed"
"""
